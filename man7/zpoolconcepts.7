.\"
.\" CDDL HEADER START
.\"
.\" The contents of this file are subject to the terms of the
.\" Common Development and Distribution License (the "License").
.\" You may not use this file except in compliance with the License.
.\"
.\" You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
.\" or https://opensource.org/licenses/CDDL-1.0.
.\" See the License for the specific language governing permissions
.\" and limitations under the License.
.\"
.\" When distributing Covered Code, include this CDDL HEADER in each
.\" file and include the License file at usr/src/OPENSOLARIS.LICENSE.
.\" If applicable, add the following below this CDDL HEADER, with the
.\" fields enclosed by brackets "[]" replaced with your own identifying
.\" information: Portions Copyright [yyyy] [name of copyright owner]
.\"
.\" CDDL HEADER END
.\"
.\" Copyright (c) 2007, Sun Microsystems, Inc. All Rights Reserved.
.\" Copyright (c) 2012, 2018 by Delphix. All rights reserved.
.\" Copyright (c) 2012 Cyril Plisko. All Rights Reserved.
.\" Copyright (c) 2017 Datto Inc.
.\" Copyright (c) 2018 George Melikov. All Rights Reserved.
.\" Copyright 2017 Nexenta Systems, Inc.
.\" Copyright (c) 2017 Open-E, Inc. All Rights Reserved.
.\"
.Dd April 7, 2023
.Dt ZPOOLCONCEPTS 7
.Os
.
.Sh ИМЯ
.Nm zpoolconcepts
.Nd обзор пулов хранения ZFS
.
.Sh ОПИСАНИЕ
.Ss Virtual Devices (vdevs)
Термин "виртуальное устройство" описывает одно устройство или набор устройств,
организованных в соответствии с определенными характеристиками производительности и неисправностей.
Поддерживаются следующие виртуальные устройства:
.Bl -tag -width "special"
.It Sy disk
Блочное устройство, обычно расположенное под
.Pa /dev .
ZFS может использовать отдельные фрагменты или секции, хотя рекомендуется
использовать целые диски.
Путь к диску может быть указан с помощью полного пути или сокращенного имени
.Po относительная часть рассматриваемого пути
.Pa /dev
.Pc .
Можно указать весь диск целиком, опустив обозначение фрагмента или раздела.
Например,
.Pa sda
эквивалентно
.Pa /dev/sda .
При получении целого диска ZFS автоматически помечает его, если это необходимо.
.It Sy file
Обычный файл.
Настоятельно не рекомендуется использовать файлы в качестве резервного хранилища.
Он разработан в основном для экспериментальных целей, поскольку отказоустойчивость
файла зависит от файловой системы, в которой он находится.
К файлу должен быть указан полный путь.
.It Sy mirror
Зеркальное отображение двух или более устройств.
Данные реплицируются идентичным образом во всех компонентах зеркала.
Зеркало с
.Em N No дисками размера Em X No может содержать Em X No байт и может выдерживать выход из строя Em N-1
устройств без потери данных.
.It Sy raidz , raidz1 , raidz2 , raidz3
Схема с распределенной четностью, аналогичная RAID-5/6, с улучшенным распределением
четности, которая не отличается от RAID-5/6
.Qq отверстие для записи ,
.Pq в котором данные и контроль четности становятся несовместимыми после отключения питания.
Данные и контроль четности распределяются по всем дискам в группе raidz, хотя
необязательно с одинаковой шириной полосы.
.Pp
Группа raidz может иметь одинарную, двойную или тройную четность, что означает, что группа
raidz может выдержать один, два или три сбоя, соответственно, без
потери каких-либо данных.
Тип vdev
.Sy raidz1
определяет группу  raidzс одинарной четностью; тип vdev
.Sy raidz2
определяет группу  raidz с двойной четностью; и тип vdev
.Sy raidz3
определяет группу  raidz с тройной четностью.
Тип vdev
.Sy raidz
это псевдоним для
.Sy raidz1 .
.Pp
Группа raidz с
.Em N No дисками размера Em X No с Em P No дисками с четностью могут содержать приблизительно
.Em (N-P)*X No байт и может выдерживать выход из строя Em P No устройств без потери данных .
Минимальное количество устройств в raid-группе на единицу больше, чем количество
дисков с четностью.
Для повышения производительности рекомендуется использовать от 3 до 9 устройств.
.It Sy draid , draid1 , draid2 , draid3
Вариант raidz, который обеспечивает интегрированное распределенное горячее резервирование, что позволяет
ускорить восстановление, сохраняя при этом преимущества raidz.
Сервер vdev состоит из нескольких внутренних групп raidz, каждая из которых имеет
.Em D No устройств передачи данных и Em P No устройств контроля четности .
Эти группы распределены по всем дочерним файлам, чтобы в полной
мере использовать доступную производительность диска.
.Pp
В отличие от raidz, raid использует фиксированную ширину полосы (при необходимости добавляя
нули), чтобы обеспечить полное последовательное восстановление.
Эта фиксированная ширина полосы существенно влияет как на полезную емкость, так и на скорость ввода-вывода.
Например, при использовании по умолчанию
.Em D=8 No и Em 4 Кбайт No в секторах диска минимальный размер выделяемого пространства составляет Em 32 Кбайт .
При использовании сжатия этот относительно большой размер выделяемого файла может снизить
эффективную степень сжатия.
При использовании томов ZFS (zvols) и droid значение свойства
.Sy volblocksize
увеличивается с учетом размера распределения.
Если dRAID  пул будет содержать значительное количество небольших блоков, рекомендуется также добавить
.Sy специальный 
зеркальный vdev для хранения этих блоков.
.Pp
Что касается ввода-вывода, производительность аналогична raidz, поскольку при любом чтении все
.Em D No доступ к дискам с данными должен быть обеспечен .
Количество выполненных случайных операций ввода-вывода может быть разумно приблизительно равно
.Sy floor((N-S)/(D+P))*single_drive_IOPS .
.Pp
Как и raidz, dRAID может иметь одинарную, двойную или тройную четность.
Типы
.Sy draid1 ,
.Sy draid2 ,
и
.Sy draid3
может использоваться для указания уровня четности.
Тип vdev
.Sy draid
это псевдоним для
.Sy draid1 .
.Pp
dRAID с
.Em N No дисков размера Em X , D No дисков с данными для каждой группы резервирования , Em P
.No уровеней паритета, и Em S No распределенных горячих запасных частей могут вмещать приблизительно
.Em (N-S)*(D/(D+P))*X No байт и может выдерживать выход из строя Em P
устройств без потери данных.
.It Sy draid Ns Oo Ar parity Oc Ns Oo Sy \&: Ns Ar data Ns Sy d Oc Ns Oo Sy \&: Ns Ar children Ns Sy c Oc Ns Oo Sy \&: Ns Ar spares Ns Sy s Oc
Конфигурацию dRAID, отличную от используемой по умолчанию, можно задать, добавив к ключевому слову один или несколько
из следующих необязательных аргументов
.Sy draid :
.Bl -tag -compact -width "children"
.It Ar parity
Уровень паритета (1-3).
.It Ar data
Количество устройств передачи данных в каждой группе резервирования.
Как правило, меньшее значение
.Em D No увеличит скорость ввода-вывода, улучшит степень сжатия
и ускорит повторное подключение за счет общей полезной емкости.
По умолчанию используется значение
.Em 8 , No если Em N-P-S No не меньше, чем Em 8 .
.It Ar children
Ожидаемое количество дочерних устройств.
Полезно для перекрестной проверки при составлении списка большого количества устройств.
Если указанное количество дочерних устройств отличается, возвращается сообщение об ошибке.
.It Ar spares
Количество распределенных резервных копий.
По умолчанию равно нулю.
.El
.It Sy spare
Псевдо-vdev, который отслеживает доступные запасные части для бассейна.
Для получения дополнительной информации смотрите раздел
.Sx Hot Spares .
.It Sy log
Отдельное устройство для ведения журнала намерений.
Если указано более одного устройства для ведения журнала, то операции записи распределяются по нагрузке между
устройствами.
Устройства для ведения журнала могут быть зеркально отображены.
Однако типы raidz vdev для ведения журнала намерений не поддерживаются.
Дополнительные сведения смотрите в разделе
.Sx Intent Log .
.It Sy dedup
Устройство, предназначенное исключительно для таблиц дедупликации.
Избыточность этого устройства должна соответствовать избыточности других обычных
устройств в пуле.
Если указано более одного устройства дедупликации, то
нагрузка распределяется равномерно между этими устройствами.
.It Sy special
Устройство, предназначенное исключительно для размещения различных видов внутренних метаданных
и, при необходимости, небольших файловых блоков.
Избыточность этого устройства должна соответствовать избыточности других обычных
устройств в пуле.
Если указано более одного специального устройства, то
распределение нагрузки между этими устройствами осуществляется с учетом баланса нагрузки.
.Pp
Для получения дополнительной информации о специальных ассигнованиях смотрите раздел
.Sx Special Allocation Class .
.It Sy cache
Устройство, используемое для кэширования данных пула хранения.
Устройство кэширования не может быть настроено как зеркало или группа raidz.
Дополнительную информацию смотрите в разделе
.Sx Cache Devices .
.El
.Pp
Виртуальные устройства не могут быть вложены произвольно.
Виртуальное устройство mirror, raidz или raid-массив может быть создано только с файлами или дисками.
Зеркала зеркал или другие подобные комбинации не допускаются.
.Pp
В верхней части конфигурации пула может быть любое количество виртуальных устройств
.Po известный как
.Qq root vdevs
.Pc .
Данные динамически распределяются по всем устройствам верхнего уровня для обеспечения баланса данных
между устройствами.
При добавлении новых виртуальных устройств ZFS автоматически размещает данные на новых
доступных устройствах.
.Pp
Виртуальные устройства указываются в командной строке по одному,
разделяясь пробелами.
Ключевые слова, такие как
.Sy mirror No and Sy raidz
используются для определения того, где заканчивается одна группа и начинается другая.
Например, в следующем примере создается пул с двумя корневыми vdevs,
каждый из которых является зеркалом двух дисков:
.Dl # Nm zpool Cm create Ar mypool Sy mirror Ar sda sdb Sy mirror Ar sdc sdd
.
.Ss Device Failure and Recovery
ZFS поддерживает широкий набор механизмов для обработки сбоев устройств и
повреждения данных.
Все метаданные и данные обрабатываются контрольной суммой, и при обнаружении повреждения ZFS автоматически восстанавливает поврежденные данные
из исправной копии.
.Pp
Чтобы воспользоваться преимуществами этих функций, пул должен использовать некоторую форму
избыточности, используя либо зеркальные группы, либо raidz-группы.
Хотя ZFS поддерживает работу в конфигурации без избыточности, где каждый корневой
vdev представляет собой просто диск или файл, это настоятельно не рекомендуется.
Единичный случай повреждения битов может привести к недоступности некоторых или всех ваших данных.
.Pp
Состояние работоспособности пула определяется одним из трех состояний:
.Sy online , degraded , No или Sy faulted .
В онлайн-пуле все устройства работают в обычном режиме.
Пул с ухудшенной работоспособностью - это пул, в котором одно или несколько устройств вышли из строя, но данные по-
прежнему доступны из-за избыточной конфигурации.
В пуле с ошибками повреждены метаданные или одно или несколько устройств с ошибками, а
реплик недостаточно для продолжения работы.
.Pp
На работоспособность vdev верхнего уровня, такого как зеркало или raidz-устройство,
потенциально влияет состояние связанных с ним vdev
или компонентных устройств.
vdev верхнего уровня или компонентное устройство находятся в одном из следующих состояний:
.Bl -tag -width "DEGRADED"
.It Sy DEGRADED
Один или несколько vdevs верхнего уровня находятся в неисправном состоянии, поскольку одно или несколько
устройств-компонентов отключены.
Существует достаточное количество реплик для продолжения работы.
.Pp
Одно или несколько компонентов устройства находятся в неисправном состоянии, но
существует достаточное количество копий для продолжения работы.
Основные условия следующие:
.Bl -bullet -compact
.It
Количество ошибок контрольной суммы или медленного ввода-вывода превышает допустимые уровни, и
устройство выходит из строя, что указывает на возможную неисправность.
ZFS продолжает использовать устройство по мере необходимости.
.It
Количество ошибок ввода-вывода превышает допустимые уровни.
Устройство не удалось пометить как неисправное, поскольку недостаточно
копий для продолжения работы.
.El
.It Sy FAULTED
Один или несколько виртуальных устройств верхнего уровня находятся в состоянии сбоя, поскольку одно или несколько
устройств-компонентов отключены.
Недостаточно реплик для продолжения работы.
.Pp
Одно или несколько компонентов устройства находятся в неисправном состоянии, и
для продолжения работы недостаточно копий.
Основные условия следующие:
.Bl -bullet -compact
.It
Устройство удалось открыть, но содержимое не соответствовало ожидаемым значениям.
.It
Количество ошибок ввода-вывода превышает допустимые уровни, и устройство неисправно, что
предотвращает его дальнейшее использование.
.El
.It Sy OFFLINE
Устройство явно отключается от сети командой
.Nm zpool Cm offline .
.It Sy ONLINE
Устройство подключено к сети и функционирует.
.It Sy REMOVED
Устройство было физически удалено во время работы системы.
Функция обнаружения удаления устройства зависит от аппаратного обеспечения и может поддерживаться не на всех
платформах.
.It Sy UNAVAIL
Устройство не удалось открыть.
Если пул импортируется, когда устройство было недоступно, то устройство будет
идентифицировано по уникальному идентификатору, а не по пути к нему, поскольку путь изначально никогда
не был правильным.
.El
.Pp
Ошибки контрольной суммы представляют собой события, когда диск возвращал данные, которые, как ожидалось,
были правильными, но не были.
Другими словами, это случаи скрытого повреждения данных.
Об ошибках контрольной суммы сообщается в
.Nm zpool Cm status
и
.Nm zpool Cm events .
При избыточном хранении блока поврежденный блок может быть восстановлен
(например, из raidz parity или зеркальной копии).
В этом случае ZFS сообщает об ошибке контрольной суммы для дисков, содержащих
поврежденные данные.
Если блок не может быть восстановлен (например, из-за повреждения 3 дисков
в группе raidz2), невозможно определить, какие диски были
повреждены автоматически.
В этом случае для всех дисков, на которых хранится блок, выводятся сообщения об ошибках контрольной
суммы.
.Pp
Если устройство удалено, а затем повторно подключено к системе,
ZFS попытается автоматически подключить его к сети.
Определение подключения устройства зависит от аппаратного
обеспечения и может поддерживаться не на всех платформах.
.
.Ss Hot Spares
ZFS позволяет связывать устройства с пулами как
.Qq горячий резерв .
Эти устройства активно не используются в пуле.
Но при
выходе из строя активного устройства оно автоматически заменяется на резервное.
Чтобы создать пул с резервными устройствами, укажите
.Sy spare
vdev с любым количеством устройств.
Например,
.Dl # Nm zpool Cm create Ar pool Sy mirror Ar sda sdb Sy spare Ar sdc sdd
.Pp
Запасные части могут быть распределены по нескольким пулам и могут быть добавлены с помощью команды
.Nm zpool Cm add
и удаляется с помощью команды
.Nm zpool Cm remove .
Как только будет начата замена запасных частей, новый
.Sy spare
vdev создается в конфигурации, которая будет сохраняться до тех
пор, пока не будет заменено исходное устройство.
На этом этапе резервное устройство снова становится доступным, если другое устройство выходит из строя.
.Pp
Если у пула есть общее пространство, которое используется в данный момент, пул нельзя
экспортировать, поскольку другие пулы могут использовать это общее пространство, что может привести к
потенциальному повреждению данных.
.Pp
Общие резервные хранилища создают определенный риск.
Если пулы импортируются на разные хосты
и в обоих пулах одновременно происходит сбой устройства,
оба могут попытаться использовать резервное хранилище одновременно.
Это может не быть обнаружено, что приведет к повреждению данных.
.Pp
Текущая замена резервного устройства может быть отменена путем отсоединения аварийного устройства.
Если исходное неисправное устройство отсоединено, то аварийное устройство займет свое
место в конфигурации и будет удалено из списка резервных устройств всех активных
пулов.
.Pp
Тип vdev
.Sy draid
предоставляет распределенные горячие запасные части.
Эти горячие запасные части названы в честь dRAID vdev, частью которого они являются
.Po Sy draid1 Ns - Ns Ar 2 Ns - Ns Ar 3 No erfpsdftn запасной Ar 3 No из vdev Ar 2 ,
.No который является единственным dRAID четности Pc
и могут использоваться только этим драйвером vdev.
В остальном они работают так же, как и обычные горячие запасные части.
.Pp
Запасные части не могут заменить регистрационные устройства.
.
.Ss Intent Log
Журнал намерений ZFS (ZIL) удовлетворяет требованиям POSIX для синхронных
транзакций.
Например, базы данных часто требуют, чтобы их транзакции находились на стабильных
устройствах хранения при возврате из системного вызова.
NFS и другие приложения также могут использовать
.Xr fsync 2
для обеспечения стабильности данных.
По умолчанию журнал намерений хранится в блоках основного пула.
Однако можно повысить производительность, используя отдельные
устройства для ведения журнала намерений, такие как NVRAM или выделенный диск.
Например:
.Dl # Nm zpool Cm create Ar pool sda sdb Sy log Ar sdc
.Pp
Также можно указать несколько устройств регистрации, и они могут быть зеркально отображены.
Смотрите раздел
.Sx ПРИМЕРЫ
для примера приведем зеркальное отображение нескольких устройств ведения журнала.
.Pp
Устройства регистрации можно добавлять, заменять, подключать, отсоединять и удалять.
Кроме того, устройства регистрации импортируются и экспортируются как часть
содержащего их пула.
Зеркальные устройства можно удалить, указав зеркальный vdev верхнего уровня.
.
.Ss Cache Devices
Устройства могут быть добавлены в пул хранения как
.Qq устройства кэширования .
Эти устройства обеспечивают дополнительный уровень кэширования между основной памятью и
диском.
Для рабочих нагрузок с высокой интенсивностью чтения, когда размер рабочего набора намного превышает то, что
может быть кэшировано в основной памяти, использование кэширующих устройств позволяет передавать гораздо большую часть этого
рабочего набора с носителей с низкой задержкой.
Использование устройств кэширования обеспечивает максимальное повышение производительности при произвольном
чтении в основном статического контента.
.Pp
Чтобы создать пул с кэширующими устройствами, укажите
.Sy cache
vdev с любым количеством устройств.	
Например:
.Dl # Nm zpool Cm create Ar pool sda sdb Sy cache Ar sdc sdd
.Pp
Устройства кэширования не могут быть зеркально отображены или являться частью конфигурации raidz.
Если на устройстве кэширования обнаруживается ошибка чтения, то данные для ввода-вывода повторно передаются
на исходное устройство пула хранения, которое может быть частью зеркальной конфигурации или
конфигурации raidz.
.Pp
Содержимое кэш-устройств сохраняется при перезагрузках и восстанавливается
асинхронно при импорте пула в L2ARC (постоянный L2ARC).
Это можно отключить, установив
.Sy l2arc_rebuild_enabled Ns = Ns Sy 0 .
Для устройств с кэш-памятью размером менее
.Em 1 Гб ,
ZFS не записывает структуры метаданных,
необходимые для перестройки L2ARC, для экономии места.
Это можно изменить с помощью
.Sy l2arc_rebuild_blocks_min_l2size .
Заголовок устройства кэширования
.Pq Em 512 Б
обновляется, даже если структуры метаданных не записаны.
Установка
.Sy l2arc_headroom Ns = Ns Sy 0
это приведет к сканированию полноразмерных списков ARC на предмет кэшируемого содержимого, которое должно быть
записано в L2ARC (постоянная дуга).
Если устройство кэширования добавлено с
.Nm zpool Cm add ,
его метка и заголовок будут перезаписаны, и его содержимое не будет
восстановлено в L2ARC, даже если устройство ранее было частью пула.
Если кэш-устройство подключено к
.Nm zpool Cm online ,
его содержимое будет восстановлено в L2ARC.
Это полезно в случае нехватки памяти,
когда содержимое кэш-устройства не полностью восстанавливается в L2ARC.
Пользователь может отключить кэш-устройство и подключить его к сети, когда объем памяти становится
меньше, чтобы полностью восстановить его содержимое в L2ARC.
.
.Ss Pool checkpoint
Перед началом критических процедур, включающих разрушительные действия
.Pq как Nm zfs Cm destroy ,
администратор может проверить состояние пула и в случае
ошибки или сбоя перемотать весь пул обратно к контрольной точке.
В противном случае контрольная точка может быть удалена после успешного завершения процедуры.
.Pp
Контрольную точку пула можно рассматривать как моментальный снимок всего пула, и ее следует использовать
с осторожностью, поскольку она содержит все сведения о состоянии пула, от свойств до
конфигурации vdev.
Таким образом, некоторые операции запрещены, пока в пуле есть контрольная точка.
В частности, удаление/присоединение/отсоединение vdev, зеркальное разделение и
изменение GUID пула.
Поддерживается добавление нового vdev, но в случае перемотки его придется
добавлять заново.
Наконец, пользователи этой функции должны иметь в виду, что проверки в пуле, имеющем контрольную точку, не восстанавливают данные с контрольными точками.
.Pp
Чтобы создать контрольную точку для пула:
.Dl # Nm zpool Cm checkpoint Ar pool
.Pp
Чтобы позже вернуть его в состояние контрольной точки, вам нужно сначала экспортировать его, а
затем перемотать назад во время импорта:
.Dl # Nm zpool Cm export Ar pool
.Dl # Nm zpool Cm import Fl -rewind-to-checkpoint Ar pool
.Pp
Чтобы удалить контрольную точку из пула, выполните следующие действия:
.Dl # Nm zpool Cm checkpoint Fl d Ar pool
.Pp
Резервирование наборов данных (контролируется свойствами
.Sy reservation No и Sy refreservation )
может оказаться невыполнимым, пока существует контрольная точка, поскольку
контрольной точке разрешено использовать резервирование наборов данных.
Наконец, данные, которые являются частью контрольной точки, но были освобождены в
текущем состоянии пула, не будут проверяться во время проверки.
.
.Ss Special Allocation Class
Выделения в специальном классе предназначены для определенных типов блоков.
По умолчанию это включает все метаданные, косвенные блоки пользовательских данных и
любые таблицы дедупликации.
Класс также может быть подготовлен для работы с небольшими файловыми блоками.
.Pp
В пуле всегда должен быть хотя бы один обычный
.Pq non- Ns Sy dedup Ns /- Ns Sy special
vdev прежде
чем другие устройства могут быть отнесены к специальному классу.
Если класс
.Sy special
становится заполненным, тогда предназначенные для него выделения
будут возвращены в обычный класс.
.Pp
Таблицы дедупликации можно исключить из специального класса, отключив параметр
.Sy zfs_ddt_data_is_special
модуля ZFS.
.Pp
Включение небольших файловых блоков в специальный класс является обязательным.
Каждый набор данных может регулировать размер небольших файловых блоков, разрешенных
в специальном классе, путем настройки свойства
.Sy special_small_blocks
к ненулевому значению.
Смотрите
.Xr zfsprops 7
для получения дополнительной информации об этом свойстве.
